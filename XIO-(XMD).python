#              ___   ___  ___ ______ 
#              \  \ /  / |   |      |
#               \  V  /  |   |  --  |
#                >   <   |   |  --  |
#               /  .  \  |   |      |
#              /__/ \__\ |___|______|
#
# Module Name: XMD (Xerox Module Downloader)
# Developer: XeroxDeveloper
# Description: Advanced Module Manager for Heroku Userbot

# This module provides a robust API for module management,
# custom configurations, and repository synchronization.

import os
import sys
import json
import asyncio
import logging
import inspect
import requests
import aiohttp
import importlib
from datetime import datetime
from .. import loader, utils

logger = logging.getLogger(__name__)

# Registration of XMD in sys.modules for 'import xmd' support
class XMDCache:
    def __init__(self):
        self.version = "1.0.0"
        self.developer = "@XeroxDevelopment"
        self.modules_registry = {}
        self.start_time = datetime.now()

xmd_api = XMDCache()
sys.modules['xmd'] = xmd_api

@loader.tds
class XMDMod(loader.Module):
    
    strings = {
        "name": "XMD",
        "repo_added": "<b>[XMD]</b> ‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω: <code>{}</code>",
        "repo_exists": "<b>[XMD]</b> ‚ö†Ô∏è –≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ.",
        "repo_invalid": "<b>[XMD]</b> ‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.",
        "searching": "<b>[XMD]</b> üîç –ü–æ–∏—Å–∫ –º–æ–¥—É–ª—è <code>{}</code>...",
        "downloading": "<b>[XMD]</b> üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è <code>{}</code>...",
        "installing": "<b>[XMD]</b> ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞...",
        "success": "<b>[XMD]</b> ‚úÖ –ú–æ–¥—É–ª—å <code>{}</code> —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!",
        "fail": "<b>[XMD]</b> ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–ª–∏ —Å–∫–∞—á–∞—Ç—å –º–æ–¥—É–ª—å.",
        "xhelp_header": "<b>‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë üí† XMD MODULE HELP üí†\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</b>\n\n",
        "cfg_header": "<b>‚öôÔ∏è XMD CONFIGURATION MANAGER</b>\n\n",
        "not_found": "<b>[XMD]</b> ‚ùå –ú–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö."
    }

    def __init__(self):
        self.config = loader.ModuleConfig(
            "DEFAULT_REPO", "https://github.com/XeroxDeveloper/module-repo/", "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
            "AUTO_UPDATE", True, "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å XMD API"
        )

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        self._repos = self.db.get("XMD", "repos", [self.config["DEFAULT_REPO"]])
        xmd_api.db = db
        xmd_api.client = client

    async def xrepocmd(self, message):
      
        args = utils.get_args_raw(message)
        if not args:
            repos_list = "\n".join([f"‚Ä¢ <code>{r}</code>" for r in self._repos])
            return await utils.answer(message, f"<b>üìÇ –°–ø–∏—Å–æ–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ XMD:</b>\n{repos_list}")

        repo_url = args.strip()
        if not repo_url.startswith("https://github.com/"):
            return await utils.answer(message, self.strings("repo_invalid"))

        if repo_url in self._repos:
            return await utils.answer(message, self.strings("repo_exists"))

        self._repos.append(repo_url)
        self.db.set("XMD", "repos", self._repos)
        await utils.answer(message, self.strings("repo_added").format(repo_url))

    async def xmdcmd(self, message):
      
        args = utils.get_args_raw(message)
        if not args:
            return await utils.answer(message, "<b>[XMD]</b> –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è –∏–ª–∏ —Å—Å—ã–ª–∫—É.")

        module_name = args.strip()
        if not module_name.endswith(".py"):
            target_file = module_name + ".py"
        else:
            target_file = module_name

        await utils.answer(message, self.strings("searching").format(target_file))

        found_url = None
        # –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–∞ –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞
        if module_name.startswith("http"):
            found_url = module_name.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/")
        else:
            # –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º
            for repo in self._repos:
                raw_base = repo.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/")
                if not raw_base.endswith("/"): raw_base += "/"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ (GitHub API –∏–ª–∏ –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å)
                check_url = f"{raw_base}main/{target_file}"
                try:
                    async with aiohttp.ClientSession() as session:
                        async with session.get(check_url) as resp:
                            if resp.status == 200:
                                found_url = check_url
                                break
                except: continue
                
                # –ü—Ä–æ–±—É–µ–º master –≤–µ—Ç–∫—É
                check_url = f"{raw_base}master/{target_file}"
                try:
                    async with aiohttp.ClientSession() as session:
                        async with session.get(check_url) as resp:
                            if resp.status == 200:
                                found_url = check_url
                                break
                except: continue

        if not found_url:
            return await utils.answer(message, self.strings("not_found"))

        await utils.answer(message, self.strings("downloading").format(target_file))
        
        try:
            r = requests.get(found_url)
            content = r.text
            
            # –õ–æ–∫–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥—É–ª—è
            path = os.path.join("userbot/modules/", target_file)
            with open(path, "w", encoding="utf-8") as f:
                f.write(content)

            await utils.answer(message, self.strings("installing"))
            
            # –í—ã–∑–æ–≤ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –∑–∞–≥—Ä—É–∑–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å –≤ –±–æ—Ç–µ
            if hasattr(self, "allmodules"): # –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–∑–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∑–∞–≥—Ä—É–∑—á–∏–∫
                 await self.allmodules.commands["dlmod"](message)
            else:
                 # –°–∏–º—É–ª–∏—Ä—É–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É –∏–ª–∏ –ª–æ–∞–¥–µ—Ä
                 await utils.answer(message, self.strings("success").format(target_file))
                 # –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —è–¥—Ä–∞, —Ç—É—Ç –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è .restart
        except Exception as e:
            await utils.answer(message, f"<b>[XMD] –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:</b> <code>{str(e)}</code>")

    async def xhelpcmd(self, message):
        mods = self.allmodules.modules
        out = self.strings("xhelp_header")
        
        sorted_mods = sorted(mods, key=lambda x: x.strings["name"] if hasattr(x, "strings") else "Unknown")
        
        for mod in sorted_mods:
            mod_name = mod.strings["name"] if hasattr(mod, "strings") else mod.__class__.__name__
            try:
                # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –º–æ–¥—É–ª—è
                commands = [f".{method_name.replace('cmd', '')}" for method_name, _ in inspect.getmembers(mod, predicate=inspect.ismethod) if method_name.endswith('cmd')]
                
                if not commands: continue
                
                out += f"<b>üí† {mod_name}</b>\n"
                out += f"<i>   {' '.join(commands)}</i>\n\n"
            except:
                continue

        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞ –≤ "—Ü–∏—Ç–∞—Ç—É" (—Å—Ç–∏–ª—å Heroku)
        if len(out) > 4096:
            # –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ, —Ä–∞–∑–±–∏–≤–∞–µ–º
            for x in range(0, len(out), 4096):
                await message.client.send_message(message.chat_id, out[x:x+4096])
        else:
            await utils.answer(message, out)

    async def xcfgcmd(self, message):
        """–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏ –º–æ–¥—É–ª–µ–π XMD"""
        args = utils.get_args_raw(message)
        if not args:
            out = self.strings("cfg_header")
            configs = self.db.get("loader", "config", {})
            for mod, data in configs.items():
                out += f"<b>üîπ {mod}:</b>\n"
                for key, val in data.items():
                    out += f"   <code>{key}</code>: <i>{val}</i>\n"
            
            if len(out) > 4096:
                return await utils.answer(message, "<b>[XMD]</b> –ö–æ–Ω—Ñ–∏–≥ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –ø–æ –º–æ–¥—É–ª—é.")
            return await utils.answer(message, out)
        
        # –ü–æ–∏—Å–∫ –∫–æ–Ω—Ñ–∏–≥–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–æ–¥—É–ª—è
        mod_name = args.strip()
        configs = self.db.get("loader", "config", {})
        if mod_name in configs:
            out = f"<b>‚öôÔ∏è Config for {mod_name}:</b>\n\n"
            for key, val in configs[mod_name].items():
                out += f"üîò <code>{key}</code>: {val}\n"
            await utils.answer(message, out)
        else:
            await utils.answer(message, f"<b>[XMD]</b> –ö–æ–Ω—Ñ–∏–≥ –¥–ª—è –º–æ–¥—É–ª—è <code>{mod_name}</code> –Ω–µ –Ω–∞–π–¥–µ–Ω.")

    # --- API Methods for other modules ---
    
    def get_api_version(self):
        return xmd_api.version

    def register_ext_module(self, name, data):
      
        xmd_api.modules_registry[name] = {
            "installed_at": datetime.now().isoformat(),
            "data": data
        }
        return True

    async def fetch_remote_config(self, url):
      
        async with aiohttp.ClientSession() as session:
            async with session.get(url) as resp:
                return await resp.json()

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ API
xmd_api.get_version = lambda: "1.0.0-PRO"
xmd_api.utils = utils

# –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:
# –í –¥—Ä—É–≥–æ–º –º–æ–¥—É–ª–µ: 
# try:
#     import xmd
#     xmd.register_ext_module("MyMod", {"status": "active"})
# except: pass

# –≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –∫–∞–∫ —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞. 
# –ö–æ–¥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å—Ä–µ–¥–µ Heroku Userbot.
# –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!
